import React from 'react';
import { useFormik } from 'formik';
import PerPageLayout from 'layout/perpage';
import TitleHeader from 'components/title-header';
import useAppSelector from 'store/hooks/useselector';
import css from 'styles/cart.module.scss';
import { NextPageWithLayout } from 'typings/layout';
import Input from 'components/element/input';
import { useGetCheckoutSession } from 'network-requests/queries';
import { useUpdateCheckoutSession } from 'network-requests/hooks/amazon-pay';
import { useRouter } from 'next/router';
import { createOrder } from 'network-requests/api';
import { v4 } from 'uuid';
import AmazonPayAPBCheckoutButton from 'components/payments/amazon-apb-checkout-component';
import { checkoutABPValidationSchema } from 'constants/checkout-validation-schema';

const Checkout: NextPageWithLayout = () => {
  const router = useRouter();
  const {
    mutate: updateCheckoutSessionMutate,
    data: updateCheckoutSessionData,
  } = useUpdateCheckoutSession();
  const { items: cartItems, ...cartState } = useAppSelector(
    (state) => state.cart
  );

  const { totalPrice } = useAppSelector((state) => state.cart);
  const totalArray = cartItems.map(
    (item: { quantity: number; total: number }) => item.quantity * item.total
  );
  const cartTotal: number = totalArray.reduce(
    (i: number, a: number) => i + a,
    0
  );

  // console.log({ checkoutPayload });
  /**
   * Create Checkout Payload
   */
  // const createPayload = React.useMemo(() => {
  //   const orderItems = cartItems.map((item: any) => {
  //     return {
  //       _id: item?.bed?.variantId,
  //       bedId: item?.bed?._id,
  //       color: item?.accessories?.color?._id,
  //       headboard: item?.accessories?.headboard?._id,
  //       mattress: item?.accessories?.mattress?._id,
  //       feet: item?.accessories?.feet?._id,
  //       storage: item?.accessories?.storage?._id,
  //       quantity: item?.quantity,
  //     };
  //   });

  //   return {
  //     user: {
  //       firstName: checkoutPayload?.buyer?.name,
  //       lastName: '\n',
  //       email: checkoutPayload?.buyer?.email,
  //       phone: checkoutPayload?.buyer?.phoneNumber,
  //     },
  //     // couponId: coupon?._id,
  //     orderItems: orderItems,
  //     shippingAddress: {
  //       address: checkoutPayload?.shippingAddress?.addressLine1,
  //       townCity: checkoutPayload?.shippingAddress?.city,
  //       postalCode: checkoutPayload?.shippingAddress?.postalCode,
  //       country: checkoutPayload?.billingAddress?.county,
  //       companyName: '',
  //     },
  //     billingAddress: {
  //       address: checkoutPayload?.billingAddress?.addressLine1,
  //       townCity: checkoutPayload?.billingAddress?.city,
  //       postalCode: checkoutPayload?.billingAddress?.postalCode,
  //       country: checkoutPayload?.billingAddress?.county,
  //       companyName: '',
  //     },
  //     orderNotes: '',
  //     payment: {
  //       paymentMethod: 'amazonpay',
  //     },
  //     extraDelivery: {
  //       price: cartState.extraDelivery?.price,
  //       name: cartState.extraDelivery?.name,
  //     },
  //   };
  // }, [cartItems, cartState.extraDelivery?.price, cartState.extraDelivery?.name]);

  // const onPlaceOrder = React.useCallback(async () => {
  //   try {
  //     const data = await createOrder(createPayload);
  //     console.log({ data });
  //   } catch (error) {
  //     console.log(error);
  //   }
  // }, [createPayload]);

  const initialValues = {
    name: '',
    email: '',
    addressLine1: '',
    city: '',
    stateOrRegion: 'UK',
    postalCode: '',
    countryCode: 'GBP',
    phoneNumber: '',
    checkbox: false,
  };

  // FORMIK FOR VALIDATION OF FORM
  const formik = useFormik({
    initialValues,
    validationSchema: checkoutABPValidationSchema,
    onSubmit: (values) => {
      console.log(values);
    },

    isInitialValid: false,
  });

  return (
    <React.Fragment>
      <TitleHeader title="Amazon Pay Checkout" />
      <form className={css.item} onSubmit={formik.handleSubmit}>
        <div className="container">
          <div className={css.row}>
            <div className={css.item1}>
              <div className={css.billformbox}>
                <h3>YOURS DETAILS</h3>
                <ul>
                  <div className={css.billform}>
                    <li>
                      <div className="row">
                        <div className="col-md-12">
                          <Input
                            name="name"
                            type="text"
                            placeholder="Enter your first name"
                            label="Name*"
                            onChange={formik.handleChange}
                            onBlur={formik.handleBlur}
                            error={formik.errors.name as any}
                            value={formik.values.name}
                          />
                        </div>
                        <div className="col-md-12">
                          <Input
                            type="tel"
                            name="phoneNumber"
                            id="country"
                            placeholder="Phone Number"
                            label="Phone *"
                            onChange={formik.handleChange}
                            onBlur={formik.handleBlur}
                            error={formik.errors.phoneNumber as any}
                            value={formik.values.phoneNumber}
                          />
                        </div>

                        <div className="col-md-12">
                          <Input
                            name="email"
                            label="Email address *"
                            placeholder="Email Address"
                            id="email"
                            type="email"
                            onChange={formik.handleChange}
                            onBlur={formik.handleBlur}
                            error={formik.errors.email as any}
                            value={formik.values.email}
                          />
                        </div>
                      </div>
                    </li>
                  </div>

                  <h3 className={css.formh3}>DELIVERY ADDRESS</h3>
                  <div className={css.billform}>
                    <li>
                      <div className="row">
                        <div className="col-md-6">
                          <p className={css.countryinput}>Country/Region *</p>
                          <h3 className={css.countryinput1}>
                            United Kingdom (UK)
                          </h3>
                        </div>
                      </div>
                    </li>

                    <li>
                      <div className="row">
                        <div className="col-md-12">
                          <Input
                            type="text"
                            name="addressLine1"
                            placeholder="House number and street name"
                            label="Address*"
                            onChange={formik.handleChange}
                            onBlur={formik.handleBlur}
                            error={formik.errors.addressLine1 as any}
                            value={formik.values.addressLine1}
                          />
                        </div>
                      </div>
                    </li>
                    <li>
                      <div className="row">
                        <Input
                          id="town"
                          type="text"
                          name="city"
                          placeholder="Town/City..."
                          label="Town / City *"
                          onChange={formik.handleChange}
                          onBlur={formik.handleBlur}
                          error={formik.errors.city as any}
                          value={formik.values.city}
                        />
                      </div>
                    </li>
                    <li>
                      <div className="row">
                        <div className="col-md-12">
                          <Input
                            type="text"
                            name="postalCode"
                            id="country"
                            placeholder="Enter your postcode"
                            label="Postcode *"
                            onChange={formik.handleChange}
                            onBlur={formik.handleBlur}
                            error={formik.errors.postalCode as any}
                            value={formik.values.postalCode}
                          />
                        </div>
                      </div>
                    </li>
                  </div>
                </ul>
              </div>
            </div>
            <div className={css.button}>
              <div className={css['summary']}>
                <p className={css['bag-item']}>
                  My Bag have{' '}
                  <strong className={css.colorchange}>
                    {' '}
                    {cartItems?.length}
                  </strong>{' '}
                  item (s)
                </p>
                {cartItems.map((data: any, index: any) => {
                  return (
                    <BagItemsSummary
                      key={index}
                      totalPrice={data.total}
                      {...data}
                    />
                  );
                })}

                {/* Summary Data */}
                <div className={css.checkform}>
                  <div className={css.items}>
                    <p>Price Summary </p>
                    <div className={css.price}>
                      <p>Sub Total (Incl.of taxes) </p>
                      <p>£{totalPrice?.toFixed(2)}</p>
                    </div>
                    <div className={css.price}>
                      <p>Shipping</p>
                      <p>FREE</p>
                    </div>
                    <div className={css.price}>
                      <p>Payment Method</p>
                      <p>Amazon Pay</p>
                    </div>

                    {/* <AmazonPayChangePayment
                      amazonCheckoutSessionId={amazonCheckoutSessionId}
                    /> */}

                    <div className={css.price}>
                      <p>Total</p>
                      <p>£{totalPrice.toFixed(2)}</p>
                    </div>

                    <div>
                      <div className={css['checkbox']}>
                        <input
                          name="checkbox"
                          type="checkbox"
                          checked={formik.values.checkbox}
                          onChange={formik.handleChange}
                        />
                        <label>
                          I have read and agree to the{' '}
                          <span
                            style={{
                              color: '#0170b9',
                              fontWeight: '800',
                              cursor: 'pointer',
                            }}
                          >
                            {' '}
                            terms and conditions
                          </span>{' '}
                          &{' '}
                          <span
                            style={{
                              color: '#0170b9',
                              fontWeight: '800',
                              cursor: 'pointer',
                            }}
                          >
                            {' '}
                            Delivery Policy.
                          </span>
                        </label>
                      </div>

                      <AmazonPayAPBCheckoutButton
                        estimatedOrderAmount={{
                          price: Number(totalPrice),
                          currencyCode: 'GBP',
                        }}
                        addressDetails={{
                          name: 'Paul Smith',
                          // email: 'example@gmail.com',
                          addressLine1: '9999 First Avenue',
                          city: 'New York',
                          stateOrRegion: 'NY',
                          postalCode: '10016',
                          countryCode: 'GB',
                          phoneNumber: '212555555',
                        }}
                      />

                      <div className={css['error-message']}>
                        {formik.errors.checkbox && (
                          <span style={{ color: 'red' }}>{'Required'}</span>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>
    </React.Fragment>
  );
};
export default Checkout;

Checkout.getLayout = PerPageLayout;

interface ItemsSummaryProps {
  bed: any;
  accessories: any;
  onRemove: () => void;
  totalPrice: number;
}

const BagItemsSummary = ({
  bed,
  totalPrice,
  accessories,
}: ItemsSummaryProps) => {
  console.log({ bed });

  const notToShow = React.useMemo(() => ['low-divan-bed'], []);

  const isDivanbed = React.useMemo(() => {
    return bed?.categories?.some((item: any) => notToShow?.includes(item));
  }, [bed?.categories, notToShow]);

  return (
    <React.Fragment>
      <div className={css['summary-container']}>
        <div className={css['summary-items']}>
          <h4 className={css['product-name']}>{bed?.name}</h4>
          <ul>
            <li>
              <span>Bed Size </span>
              <span>:</span>
              <span>{bed?.size}</span>
            </li>
            {accessories?.color.name?.length > 0 && (
              <li>
                <strong>Selected Color :</strong>
                {accessories?.color.name}
              </li>
            )}

            <li>
              <strong>Selected Headboard :</strong>
              {accessories?.headboard?.name || 'No Headboard'}
            </li>

            {!isDivanbed && (
              <li>
                <strong>Selected Storage:</strong>
                {accessories?.storage?.name || 'No Storage'}
              </li>
            )}

            <li>
              <strong>Selected Mattress : </strong>
              {accessories?.mattress?.name || 'No Mattress'}
            </li>
          </ul>
        </div>
        <div className={css['price-summary']}>
          <h5>
            <span> Price</span> <span>£{totalPrice}</span>
          </h5>
        </div>
      </div>
    </React.Fragment>
  );
};
